<?php
/**
 *    GVV Gestion vol à voile
 *    Copyright (C) 2011  Philippe Boissel & Frédéric Peignot
 *
 *    This program is free software: you can redistribute it and/or modify
 *    it under the terms of the GNU General Public License as published by
 *    the Free Software Foundation, either version 3 of the License, or
 *    (at your option) any later version.
 *
 *    This program is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *    GNU General Public License for more details.
 *
 *    You should have received a copy of the GNU General Public License
 *    along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * User Roles Management View
 *
 * @package views
 */

$this->load->view('bs_header');
$this->load->view('bs_menu');
$this->load->view('bs_banner');
?>

<div id="body" class="body container-fluid">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="<?= site_url('authorization') ?>"><?= $this->lang->line('authorization_title') ?></a></li>
            <li class="breadcrumb-item active" aria-current="page"><?= $this->lang->line('authorization_users') ?></li>
        </ol>
    </nav>

    <h3><?= $title ?></h3>

    <?php if (!empty($message)): ?>
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <?= $message ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <?php endif; ?>

    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0"><?= $this->lang->line('authorization_user_roles_list') ?></h5>
        </div>
        <div class="card-body">
            <table id="userRolesTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th><?= $this->lang->line('authorization_username') ?></th>
                        <th><?= $this->lang->line('authorization_email') ?></th>
                        <th><?= $this->lang->line('authorization_name') ?></th>
                        <th><?= $this->lang->line('authorization_section') ?></th>
                        <th><?= $this->lang->line('authorization_current_roles') ?></th>
                        <th><?= $this->lang->line('authorization_actions') ?></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($users as $user): ?>
                        <tr>
                            <td><?= htmlspecialchars($user['username']) ?></td>
                            <td><?= htmlspecialchars($user['email']) ?></td>
                            <td>
                                <?php if (!empty($user['mprenom']) || !empty($user['mnom'])): ?>
                                    <?= htmlspecialchars($user['mprenom']) ?> <?= htmlspecialchars($user['mnom']) ?>
                                <?php else: ?>
                                    <em>-</em>
                                <?php endif; ?>
                            </td>
                            <td>
                                <?php if (!empty($user['section_name'])): ?>
                                    <?= htmlspecialchars($user['section_name']) ?>
                                <?php else: ?>
                                    <em><?= $this->lang->line('authorization_no_section') ?></em>
                                <?php endif; ?>
                            </td>
                            <td>
                                <?php if (!empty($user['roles'])): ?>
                                    <?php foreach ($user['roles'] as $role): ?>
                                        <span class="badge bg-primary me-1" data-role-id="<?= $role['types_roles_id'] ?>">
                                            <?= htmlspecialchars($role['role_name']) ?>
                                            <?php if ($role['scope'] === 'global'): ?>
                                                <i class="fas fa-globe" title="Global"></i>
                                            <?php endif; ?>
                                        </span>
                                    <?php endforeach; ?>
                                <?php else: ?>
                                    <em><?= $this->lang->line('authorization_no_roles') ?></em>
                                <?php endif; ?>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-manage-roles"
                                        data-user-id="<?= $user['id'] ?>"
                                        data-username="<?= htmlspecialchars($user['username']) ?>"
                                        data-user-roles='<?= json_encode($user['roles']) ?>'>
                                    <i class="fas fa-cog"></i> Gérer les rôles
                                </button>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Manage Roles Modal -->
<div class="modal fade" id="manageRolesModal" tabindex="-1" aria-labelledby="manageRolesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manageRolesModalLabel">Gérer les rôles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Utilisateur: <strong id="manageUsername"></strong></p>
                <input type="hidden" id="manageUserId">

                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Rôle</th>
                                <th>Toutes sections</th>
                                <?php foreach ($sections as $section): ?>
                                    <?php if ($section['id'] != 0): ?>
                                        <th><?= htmlspecialchars($section['nom']) ?></th>
                                    <?php endif; ?>
                                <?php endforeach; ?>
                            </tr>
                        </thead>
                        <tbody>
                            <?php
                            // Group roles: show global roles first, then section roles
                            $global_roles = array_filter($all_roles, function($r) { return $r['scope'] === 'global'; });
                            $section_roles = array_filter($all_roles, function($r) { return $r['scope'] === 'section'; });
                            $ordered_roles = array_merge($global_roles, $section_roles);
                            ?>

                            <?php foreach ($ordered_roles as $role): ?>
                            <tr data-role-id="<?= $role['id'] ?>" data-role-scope="<?= $role['scope'] ?>">
                                <td><?php if ($role['scope'] === 'global'): ?><strong><?php endif; ?><?= htmlspecialchars($role['nom']) ?><?php if ($role['scope'] === 'global'): ?></strong><?php endif; ?></td>
                                <td class="text-center">
                                    <!-- "Toutes sections" checkbox for all roles -->
                                    <input type="checkbox" class="form-check-input role-checkbox role-checkbox-all"
                                           data-role-id="<?= $role['id'] ?>"
                                           data-role-scope="<?= $role['scope'] ?>">
                                </td>
                                <?php foreach ($sections as $section): ?>
                                    <?php if ($section['id'] != 0): ?>
                                        <td class="text-center">
                                            <?php if ($role['scope'] === 'section'): ?>
                                                <!-- Individual section checkboxes for section roles only -->
                                                <input type="checkbox" class="form-check-input role-checkbox role-checkbox-section"
                                                       data-role-id="<?= $role['id'] ?>"
                                                       data-section-id="<?= $section['id'] ?>"
                                                       data-role-scope="section">
                                            <?php else: ?>
                                                <!-- No section checkboxes for global roles -->
                                                <span class="text-muted small">—</span>
                                            <?php endif; ?>
                                        </td>
                                    <?php endif; ?>
                                <?php endforeach; ?>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>


<script>
$(document).ready(function() {
    // Store sections list globally for JavaScript access
    var allSections = <?= json_encode(array_map(function($s) { return $s['id']; }, array_filter($sections, function($s) { return $s['id'] != 0; }))) ?>;
    console.log('Available sections:', allSections);

    // Flag to prevent recursive checkbox updates
    var updatingToutesSections = false;

    // Initialize DataTable with error handling
    try {
        if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#userRolesTable')) {
            $('#userRolesTable').DataTable({
                "pageLength": 25,
                "order": [[0, "asc"]],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/fr-FR.json"
                }
            });
        }
    } catch (error) {
        console.error('DataTable initialization error:', error);
    }

    // Manage Roles Button
    $(document).on('click', '.btn-manage-roles', function(e) {
        e.preventDefault();
        const userId = $(this).data('user-id');
        const username = $(this).data('username');
        const userRoles = $(this).data('user-roles') || [];

        $('#manageUserId').val(userId);
        $('#manageUsername').text(username);

        // Update checkboxes based on user's current roles
        updateModalCheckboxes(userRoles);

        // Show modal
        new bootstrap.Modal(document.getElementById('manageRolesModal')).show();
    });

    // Handle checkbox toggle
    $(document).on('change', '.role-checkbox', function() {
        const $checkbox = $(this);
        const userId = $('#manageUserId').val();
        const roleId = $checkbox.data('role-id');
        const isAllSections = $checkbox.hasClass('role-checkbox-all');
        const isChecked = $checkbox.is(':checked');

        // Determine section_id for AJAX call
        // - For "Toutes sections" checkbox (global roles): use section_id=0
        // - For individual section checkbox (section roles): use the specific section_id
        const sectionId = isAllSections ? 0 : $checkbox.data('section-id');
        const action = isChecked ? 'grant' : 'revoke';

        console.log('Role change - userId:', userId, 'roleId:', roleId, 'sectionId:', sectionId, 'isAllSections:', isAllSections, 'action:', action);
        console.log('Checkbox data attributes:', $checkbox.data());

        // Validate required parameters
        if (!userId || !roleId || sectionId === undefined) {
            console.error('Missing required parameters:', {userId, roleId, sectionId});
            alert('Erreur: Paramètres manquants');
            $checkbox.prop('checked', !isChecked);
            return;
        }

        $checkbox.prop('disabled', true);

        $.ajax({
            url: '<?= site_url('authorization/edit_user_roles') ?>',
            type: 'POST',
            data: {
                user_id: userId,
                types_roles_id: roleId,
                section_id: sectionId,
                action: action
            },
            dataType: 'json',
            success: function(response) {
                console.log('Server response:', response);
                if (response.success) {
                    // Show success feedback without closing modal
                    const $row = $checkbox.closest('tr');
                    $row.addClass('table-success');
                    setTimeout(function() {
                        $row.removeClass('table-success');
                    }, 1000);

                    // Update the main table's role badges in the background
                    updateUserRoleBadges(userId);
                } else {
                    alert('Erreur: ' + response.message);
                    $checkbox.prop('checked', !isChecked);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX error:', {xhr, status, error, responseText: xhr.responseText});
                alert('Erreur lors de la modification du rôle');
                $checkbox.prop('checked', !isChecked);
            },
            complete: function() {
                $checkbox.prop('disabled', false);
            }
        });
    });

    // Update the role badges for a user in the main table and modal
    function updateUserRoleBadges(userId) {
        const $row = $('#userRolesTable').find('button[data-user-id="' + userId + '"]').closest('tr');
        const $badgeCell = $row.find('td').eq(4); // 5th column (roles)

        // Fetch updated roles
        $.ajax({
            url: '<?= site_url('authorization/get_user_roles') ?>',
            type: 'GET',
            data: { user_id: userId },
            dataType: 'json',
            success: function(response) {
                if (response.success && response.roles) {
                    // Update badges in main table
                    let badgesHtml = '';
                    if (response.roles.length > 0) {
                        response.roles.forEach(function(role) {
                            badgesHtml += '<span class="badge bg-primary me-1" data-role-id="' + role.types_roles_id + '">';
                            badgesHtml += role.role_name;
                            if (role.scope === 'global') {
                                badgesHtml += ' <i class="fas fa-globe" title="Global"></i>';
                            }
                            badgesHtml += '</span>';
                        });
                    } else {
                        badgesHtml = '<em><?= $this->lang->line('authorization_no_roles') ?></em>';
                    }
                    $badgeCell.html(badgesHtml);

                    // Update button data
                    $row.find('.btn-manage-roles').data('user-roles', response.roles);

                    // If modal is open for this user, update checkboxes in modal
                    if ($('#manageUserId').val() == userId) {
                        updateModalCheckboxes(response.roles);
                    }
                }
            }
        });
    }

    // Update checkboxes in the modal based on user's current roles
    function updateModalCheckboxes(userRoles) {
        console.log('updateModalCheckboxes called with roles:', userRoles);

        // Reset all checkboxes
        $('.role-checkbox').prop('checked', false);

        // Check boxes for user's current roles
        userRoles.forEach(function(role) {
            console.log('Processing role:', role, 'section_id:', role.section_id);

            if (role.section_id == 0 || role.section_id === '0') {
                // Cross-section role: check the "Toutes sections" checkbox
                const selector = '.role-checkbox-all[data-role-id="' + role.types_roles_id + '"]';
                console.log('Checking global role with selector:', selector);
                $('.role-checkbox-all[data-role-id="' + role.types_roles_id + '"]').prop('checked', true);
            } else {
                // Section-specific role: check the individual section checkbox
                const selector = '.role-checkbox-section[data-role-id="' + role.types_roles_id + '"][data-section-id="' + role.section_id + '"]';
                console.log('Checking section role with selector:', selector);
                const $checkbox = $(selector);
                console.log('Found checkboxes:', $checkbox.length);
                $checkbox.prop('checked', true);
            }
        });
    }
});
</script>


